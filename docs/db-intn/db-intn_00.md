# 前言

分布式数据库系统是大多数企业和绝大多数软件应用的重要组成部分。这些应用程序提供逻辑和用户界面，而数据库系统则负责数据的完整性、一致性和冗余性。

早在 2000 年，如果您选择数据库，您只有几个选择，而且大部分都在关系型数据库的领域内，因此它们之间的差异相对较小。当然，这并不意味着所有数据库完全相同，但它们的功能和用例非常相似。

一些这些数据库专注于*水平扩展*（*外扩*）——通过运行多个数据库实例作为单个逻辑单元来提高性能和增加容量：Gamma 数据库机器项目、Teradata、Greenplum、Parallel DB2 等等。如今，水平扩展仍然是客户期望数据库具备的最重要特性之一。这可以解释为何云服务的流行正在上升。通常情况下，通过启动新实例并将其添加到集群中比通过将数据库移至更大更强大的机器进行垂直扩展（*上扩*）更容易。迁移可能会漫长且痛苦，可能会导致停机时间。

大约在 2010 年左右，一类新型的*最终一致性*数据库开始出现，并且诸如*NoSQL*以及后来的*大数据*这样的术语变得越来越流行。在过去的 15 年里，开源社区、大型互联网公司和数据库供应商创造了许多数据库和工具，因此很容易在尝试理解使用情况、细节和具体细节时感到困惑。

2007 年由亚马逊团队发布的 Dynamo 论文[[DECANDIA07]](app01.html#DECANDIA07)对数据库社区产生了巨大影响，短时间内激发了许多变体和实现。其中最突出的是由 Facebook 创建的 Apache Cassandra，由 LinkedIn 创建的 Project Voldemort 以及由前 Akamai 工程师创建的 Riak。

如今，领域再次发生变化：在键值存储、NoSQL 和最终一致性时代之后，我们开始看到更具可伸缩性和性能的数据库，能够执行具有更强一致性保证的复杂查询。

## 本书的受众

在技术会议上的对话中，我经常听到同样的问题：“我该如何更多地了解数据库内部？我甚至不知道从哪里开始。”大多数关于数据库系统的书籍并不深入讨论存储引擎的实现细节，也没有涵盖如 B-树等访问方法的具体细节。有很少的书籍涵盖了更近期的概念，如不同的 B-树变体和日志结构化存储，因此我通常建议阅读论文。

每一个读过论文的人都知道，这并不容易：你经常缺乏上下文，措辞可能含糊不清，论文之间很少或没有联系，而且它们很难找到。这本书包含了重要数据库系统概念的简明总结，可以作为那些想要深入了解的人的指南，或者作为已经熟悉这些概念的人的备忘单。

并非每个人都想成为数据库开发人员，但这本书将帮助那些构建使用数据库系统的软件的人：软件开发人员、可靠性工程师、架构师和工程经理。

如果你的公司依赖于任何基础设施组件，无论是数据库、消息队列、容器平台还是任务调度器，你必须阅读项目的变更日志和邮件列表，以保持与社区的联系并了解项目中最新的动态。理解术语并知道内部情况将使你能够从这些来源中获取更多信息，并更有效地使用你的工具来排除故障、识别和避免潜在风险和瓶颈。了解数据库系统工作原理的概述和一般理解将有助于在出现问题时采取行动。利用这些知识，你将能够提出假设，验证假设，找到根本原因，并向其他项目维护者提出。

这本书也适合那些充满好奇心的人：对于那些喜欢在没有即时需求的情况下学习东西的人，那些把空闲时间用于有趣的事情的人，例如编写编译器、编写自制操作系统、文本编辑器、电脑游戏、学习编程语言和吸收新信息的人。

假设读者有一些开发后端系统和使用数据库系统作为*用户*的经验。具有一些不同数据结构的先前知识将有助于更快地消化材料。

## 为什么要阅读这本书？

我们经常听到人们用实现的概念和算法来描述数据库系统：“这个数据库使用八卦进行成员传播”（参见第十二章），“他们实现了 Dynamo”，或者“这就像他们在 Spanner 论文中描述的那样”（参见第十三章）。或者，如果你讨论算法和数据结构，你可能会听到类似“ZAB 和 Raft 有很多相似之处”（参见第十四章），“Bw-Trees 类似于在日志结构化存储上实现的 B-Trees”（参见第六章），或者“他们像 B^(link)-Trees 中描述的那样使用兄弟指针”（参见第五章）。

我们需要抽象化来讨论复杂的概念，我们不能每次开始对话时都讨论术语。以常见语言的形式进行快捷方式有助于我们将注意力转移到其他更高级别的问题上。

学习基本概念、证明和算法的优势之一是它们永远不会过时。当然，总会有新的算法出现，但经典算法往往是在发现缺陷或改进空间之后创建的。了解历史有助于更好地理解差异和动机。

学习这些东西是启发性的。你看到各种算法的多样性，看到我们行业如何一次又一次地解决问题，并且开始欣赏那些工作。同时，学习是有回报的：你几乎可以感受到脑海中多个拼图片段如何组合在一起形成一个完整的图景，这个图景你将永远能与他人分享。

## 本书的范围

本书既不是关于关系数据库管理系统，也不是关于 NoSQL 系统的书，而是关于各种数据库系统中使用的算法和概念，重点是*存储引擎*和负责*分布*的组件。

一些概念，如查询规划、查询优化、调度、关系模型等，已经在几本关于数据库系统的优秀教材中有所涵盖。这些概念通常从用户的角度描述，但本书侧重于内部结构。你可以在第二部分结论和章节总结中找到一些有用的文献指引。在这些书籍中，你可能会找到关于数据库相关问题的答案。

本书不讨论查询语言，因为在本书提到的数据库系统中没有单一的共同语言。

为了收集本书的材料，我研究了超过 15 本书籍，300 多篇论文，无数篇博客文章，源代码以及几个开源数据库的文档。是否将某个特定概念包含在本书中的经验法则是这样一个问题：“数据库行业和研究界的人们是否谈论这个概念？” 如果答案是“是”，我就将该概念添加到要讨论的长列表中。

## 本书的结构

有一些具有可扩展组件（如[[SCHWARZ86]](app01.html#SCHWARZ86)）的可扩展数据库示例，但它们相当罕见。与此同时，有很多例子显示数据库使用可插拔存储。同样，我们很少听到数据库供应商讨论查询执行，而他们却非常热衷于讨论他们的数据库如何保持一致性。

数据库系统之间最显著的区别集中在两个方面：它们如何*存储*和*分布*数据。 （其他子系统有时也可能很重要，但这里没有涵盖。）本书分为几个部分，讨论负责*存储*（第一部分）和*分布*（第二部分）的子系统和组件。

**第一部分** 讨论了节点本地过程，重点放在存储引擎上，这是数据库系统的核心组件，也是最显著的区分因素之一。首先，我们从数据库管理系统的架构开始，介绍了几种基于主存储介质和布局的数据库系统分类方式。

我们继续讨论存储结构，并试图了解磁盘结构与内存结构的不同之处，介绍了 B 树，并涵盖了在磁盘上高效维护 B 树结构的算法，包括序列化、页面布局和磁盘表示。随后，我们讨论了多种变体，以展示这一概念的威力和由 B 树受到影响和启发的数据结构的多样性。

最后，我们讨论了几种日志结构化存储的变体，通常用于实现文件和存储系统，动机以及使用它们的原因。

**第二部分** 讨论了如何将多个节点组织成数据库集群。我们从理解构建容错分布式系统的理论概念的重要性开始，分布式系统与单节点应用程序的不同之处，以及在分布式环境中面临的问题、约束和复杂性。

随后，我们深入研究了分布式算法。在这里，我们从故障检测算法开始，通过注意并报告故障以及避免失败节点来帮助改善性能和稳定性。由于后面讨论的许多算法依赖于理解领导概念，我们介绍了几种领导选举算法，并讨论了它们的适用性。

分布式系统中最困难的问题之一是实现数据一致性，我们讨论复制的概念，接着是一致性模型，副本之间可能出现的差异以及最终一致性。由于最终一致性系统有时依赖于反熵以实现收敛和基于猜测的数据传播，我们讨论了几种反熵和猜测方法。最后，我们在数据库事务的背景下讨论逻辑一致性，并以共识算法结束。

没有所有研究和出版物的支持，这本书将是不可能完成的。您将在文本中找到许多参考文献和出版物的引用，用方括号和等宽字体表示；例如，[[DECANDIA07]](app01.html#DECANDIA07)。您可以使用这些引用来更详细地了解相关概念。

每章结束后，您将找到一个摘要部分，其中包含进一步学习内容，与章节内容相关。

## 本书中使用的惯例

本书中使用的排版惯例：

*斜体*

指示新术语、网址、电子邮件地址、文件名和文件扩展名。

`等宽字体`

用于程序清单，以及段落内引用程序元素，如变量或函数名、数据库、数据类型、环境变量、语句和关键字。

###### 小贴士

此元素表示提示或建议。

###### 注意

此元素表示一般注释。

###### 警告

此元素表示警告或注意事项。

## 使用代码示例

本书旨在帮助您完成工作。一般情况下，如果本书提供示例代码，则您可以在您的程序和文档中使用它。除非您复制了代码的大部分，否则您无需联系我们以获得许可。例如，编写一个使用本书多个代码片段的程序不需要许可。销售或分发包含 O’Reilly 图书示例的 CD-ROM 需要许可。引用本书并引用示例代码回答问题不需要许可。将本书大量示例代码整合到产品文档中需要许可。

我们感谢您的使用，但不要求署名。署名通常包括书名、作者、出版社和 ISBN。例如：“*Database Internals* by Alex Petrov (O’Reilly)。版权所有 2019 Oleksandr Petrov，978-1-492-04034-7。”

如果您认为您使用的代码示例超出了合理使用范围或上述授权，请随时通过*permissions@oreilly.com*与我们联系。

## O’Reilly 在线学习

###### 注意

近 40 年来，[*O’Reilly Media*](http://oreilly.com) 提供技术和商业培训、知识和洞察力，帮助公司取得成功。

我们独特的专家和创新者网络通过书籍、文章和我们的在线学习平台分享他们的知识和专长。O’Reilly 的在线学习平台为您提供按需访问的实时培训课程、深入的学习路径、交互式编码环境，以及来自 O’Reilly 和 200 多家出版商的大量文本和视频。有关更多信息，请访问[*http://oreilly.com*](http://oreilly.com)。

# 如何联系我们

请将有关本书的评论和问题发送至出版商：

+   O’Reilly Media, Inc.

+   Gravenstein Highway North 1005

+   加利福尼亚州塞巴斯托波尔 95472

+   800-998-9938 (在美国或加拿大)

+   707-829-0515 (国际或本地)

+   707-829-0104 (传真)

我们为本书创建了一个网页，列出勘误、示例和任何其他信息。您可以访问[*http://bit.ly/database-internals*](http://bit.ly/database-internals)查看该页面。

要就本书发表评论或提出技术问题，请发送电子邮件至*bookquestions@oreilly.com*。

获取有关我们的图书和课程的新闻和更多信息，请访问我们的网站[*http://www.oreilly.com*](http://www.oreilly.com)。

在 Facebook 上找到我们：[*http://facebook.com/oreilly*](http://facebook.com/oreilly)

在 Twitter 上关注我们：[*http://twitter.com/oreillymedia*](http://twitter.com/oreillymedia)

在 YouTube 上关注我们：[*http://www.youtube.com/oreillymedia*](http://www.youtube.com/oreillymedia)

## 致谢

这本书的问世离不开数百名努力研究论文和书籍的人们，他们为这本书提供了思想、灵感，并作为参考文献。

我要感谢所有审阅手稿并提供反馈的人，确保本书的内容准确无误，措辞精确：Dmitry Alimov，Peter Alvaro，Carlos Baquero，Jason Brown，Blake Eggleston，Marcus Eriksson，Francisco Fernández Castaño，Heidi Howard，Vaidehi Joshi，Maximilian Karasz，Stas Kelvich，Michael Klishin，Predrag Knežević，Joel Knighton，Eugene Lazin，Nate McCall，Christopher Meiklejohn，Tyler Neely，Maxim Neverov，Marina Petrova，Stefan Podkowinski，Edward Ribeiro，Denis Rystsov，Kir Shatrov，Alex Sorokoumov，Massimiliano Tomassi 和 Ariel Weisberg。

当然，这本书离不开我的家人的支持：我的妻子 Marina 和女儿 Alexandra，在我每一个步骤上都给予了我支持。
