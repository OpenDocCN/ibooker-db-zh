# 第九章：其他挑战

本章是一个短小但重要的关于常见 MySQL 挑战的清单及其缓解方法。这些挑战不适合其他章节，因为大多数与性能无直接关系。但不要低估它们：例如，前两个挑战可以毁掉一个数据库。更重要的是，这些挑战并不是仅在恒星对齐和命运共谋的情况下才发生的特殊情况。这些都是常见的挑战。认真对待它们，并期望面对它们。

# 脑裂是最大的风险

脑裂需要同时在同一复制拓扑中发生两个条件：

+   多于一个 MySQL 实例是可写的（`read_only=0`）

+   在多个 MySQL 实例上发生写入

两者都不应该同时发生——尤其是在同一时间——但生活充满了惊喜，你无法永远避免错误或意外。一旦发生，就称之为*脑裂*：而不是所有 MySQL 实例都具有相同的数据，它们被象征性地分裂，因为数据不再在每个实例上一致（一致）。不一致的数据不仅根本是错误的，它还可能破坏复制或更糟——产生连锁反应，导致更多数据变得不一致，从而带来下一个挑战：数据漂移。

###### 注意

脑裂不适用于有意设计为具有多个可写实例的 MySQL 复制拓扑。

如果发生了脑裂，必须*立即*检测并停止它。为什么？因为一次写操作可能影响任意数量的行。短短几秒钟的脑裂可能导致一系列不一致的数据，导致*数周*的数据取证和对账工作。

要停止脑裂，禁用*所有*实例上的写入操作：`SET GLOBAL read_only=1`。不要让一个实例保持可写状态；那会使问题变得更糟。如果无法禁用写入操作，那就关闭 MySQL 或服务器——严肃点。*数据完整性比数据可用性更重要*。

###### 提示

数据完整性比数据可用性更重要。

理想情况下，应该将整个数据库离线，直到找到并协调所有不一致的数据。但现实情况是，如果长时间的数据库停机会毁掉业务，并且您绝对确定读取可能不正确的数据不会造成进一步的损害，那么您可以在修复数据时以只读模式运行 MySQL（`read_only=1`），同时使用[`super_read_only`](https://oreil.ly/JrqIs)模式。

找到不一致行的唯一两种方法是运行[`pt-table-sync`](https://oreil.ly/Dr10P)，或者手动检查。手动检查包括根据您对应用程序、数据及可能在脑裂期间发生的更改的理解，尽力进行比较和验证行。`pt-table-sync`是一个可以找到、打印和同步两个 MySQL 实例之间数据差异的开源工具，但要小心使用，因为任何更改数据的工具本质上都存在风险。

###### 警告

`pt-table-sync` 是一个危险的工具，除非你小心操作。不要使用其`--execute`选项：只使用`--print`，并彻底阅读其手册。

调和行是困难的部分，你应该与 MySQL 专家合作，确保正确执行。如果幸运的话，你会确定一个 MySQL 实例是权威的——所有行都有正确的数据——那么你可以重建而不是调和：从权威实例重新建立所有副本。如果不幸的话，那么与 MySQL 专家合作确定你的选择。

# 数据漂移是真实但看不见的

*数据漂移*指的是不一致的数据：同一复制拓扑中不同 MySQL 实例上的一个或多个行具有不同的值。（*漂移*比喻为随着不一致数据的更改导致进一步的不一致，这些值漂离得越来越远。）而来自分裂脑场景的不一致数据是预期的，来自数据漂移的不一致数据是意外的：你不知道，也没有任何理由怀疑存在不一致的数据。虽然从表面上看，数据漂移似乎不会造成问题，但它仍然是一个真实的问题，因为应用可能返回错误的值。

幸运的是，数据漂移很容易检测：运行[`pt-table-checksum`](https://oreil.ly/mogUa)。这个工具很安全：它只是读取和比较数据。不幸的是，数据漂移和由于分裂脑导致的不一致数据一样难以调和。但这可能不是问题，因为数据漂移往往是有限和局部的，不会像不一致数据的雪崩一样——因为它不是由像分裂脑这样的严重故障造成的。

数据漂移令人着迷的一面在于，据我所知，在野外（即真实的生产数据库中），从未有人找到或证明过数据漂移的根本原因。理论上，它是由于非确定性查询和基于语句的复制，或者在副本上的写入引起的。在实验室中，这两者肯定会导致数据漂移，但在野外似乎从未是原因。相反，工程师和数据库管理员一致认为没有做任何事情来导致或允许数据漂移。但它确实存在。

###### 提示

每隔几个月（或至少每年一次）运行[`pt-table-checksum`](https://oreil.ly/mogUa)检查数据漂移。如果发现了数据漂移，不要担心：调和这些行，并在一个月后再次检查。如果数据持续漂移（这种情况非常罕见），那么你就有一个值得详细调查并修复根本原因的特殊问题。

# 不要信任 ORM

对象关系映射（ORM）的目的是通过将数据访问抽象为编程术语和对象来帮助程序员。ORM 本身并不坏或低效，但你应该验证 ORM 库生成的查询，因为性能并不是它的目的。例如，由于 ORM 将行视为对象，ORM 库可能会选择所有列，这与你在高效数据访问检查表(表 3-2)中看到的情况相反。另一个例子：一些 ORM 库在实际应用查询之前或之后执行其他查询（例如`SHOW WARNINGS`）。在追求最大性能时，每个查询都很重要；其他查询是不可接受的浪费。

有一些高性能应用使用 ORM，但工程师们小心地不信任 ORM：他们验证 ORM 生成的查询在查询分析和查询报告中（分别参见“查询分析”和“查询报告”）。如果 ORM 生成的查询效率太低，可以阅读 ORM 库文档，了解如何配置以生成更高效的查询。

# 架构总是在变化。

你可能已经了解到这个挑战，但如果你刚接触任何关系数据库生活的话，我们来详细谈一谈：架构总是在变化。（更具体地说，表定义总是在变化，但表构成了一个架构。）挑战在于进行*在线架构更改*（OSC）：在使用过程中改变架构，而不影响应用程序。正如前几章所述，MySQL 有三个很好的解决方案：

+   [pt-online-schema-change](https://oreil.ly/brtmM)

+   [`gh-ost`](https://oreil.ly/ZKQAd)

+   [`ALTER TABLE`](https://oreil.ly/GRQuf)

每个解决方案的工作方式都非常不同，但它们都可以在线更改表定义，而不影响应用程序。阅读每个文档以决定哪一个最适合你。

这个挑战还有另一个方面：将架构更改集成到软件开发过程中。你可以手动运行 OSC，但工程团队不会这样做，因为像其他代码更改一样，架构更改需要成为开发过程的一部分，因此需要审核、批准、在测试环境中测试等等。由于开发流程是团队特定的，你的团队将不得不创建自己的解决方案。但目前有一个开源解决方案：[Skeema](https://www.skeema.io)。要深入了解，如何在 GitHub 上解决这个挑战的著名 MySQL 专家 Shlomi Noach，请阅读他的博客文章[“使用 GitHub Actions 等自动化 MySQL 架构迁移”](https://oreil.ly/9cEJi)。

# MySQL 扩展了标准 SQL

如果您只使用 MySQL，那么也许您可以跳过这个挑战。但如果您来自（或去往）另一个关系型数据库，那么请注意，MySQL 在 MySQL 手册中列举了许多标准 SQL 的扩展，详见[“MySQL 对标准 SQL 的扩展”](https://oreil.ly/gLN1l)。MySQL 不支持一些标准 SQL 功能，比如全外连接。还有其他限制和限制在名为[“MySQL 限制和限制”](https://oreil.ly/x3xro)的节选中列出，您将在 MySQL 手册中找到其他提及和奇特之处。

任何具有像 MySQL 这样悠久而丰富历史的数据库都必定同样充满异国风情。关于 MySQL 的独特之处是专家们自然而然地了解和信任的东西，很少有人指出：[MySQL 手册](https://oreil.ly/IXARN)是全面而权威的。软件文档可能稀缺、过时或不存在，但 MySQL 手册不是。关于 MySQL 的一些神秘信息不在手册中，但除此之外，MySQL 专家们严重依赖 MySQL 手册——你也应该如此。

# 嘈杂邻居

在物理服务器上，*嘈杂邻居*是通过使用过多系统资源而降低其他程序性能的程序。例如，如果服务器运行了 20 个独立的 MySQL 实例，但其中一个使用了所有的 CPU 和磁盘 I/O，那么它就是一个嘈杂邻居。这是一个常见的挑战，因为*共享服务器*（或*多租户*）是正常的：在单个物理服务器上运行多个虚拟化环境。相反，*专用服务器*（或*单租户*）是罕见且昂贵的，尤其是在云中。嘈杂邻居是一个令人困惑的挑战，因为性能影响不是您的错，但却是您的问题。

如果您的公司使用自己的硬件，那么问题是可以解决的：测量您怀疑存在嘈杂邻居的共享服务器上每个程序或虚拟环境的资源使用情况。嘈杂邻居很容易被发现，因为它们很吵闹。然后将嘈杂邻居（或您的数据库）迁移到另一个更安静的服务器上。如果这不可能，那么为嘈杂邻居购买另一本这本书，让他们学习如何优化 MySQL 性能。

在云中，您无法看到或证明存在嘈杂邻居。出于安全考虑，云提供商在共享服务器上严格保持租户（像您这样的客户）的分离。他们不太可能承认存在嘈杂邻居，因为这将意味着他们没有平衡服务器负载，这应该包含在成本中。因此，当您怀疑存在嘈杂邻居时，标准做法是重新配置云数据库。一些公司在使用云资源之前对其进行基准测试，只有在性能达到基线时才保留它；否则，资源将被销毁，另一个资源将被配置，这个过程会重复，直到—偶然地—资源被配置在一个安静的服务器上。

# 应用程序无法优雅地失败

Netflix 发起了 *混乱工程*：有意引入问题和故障到系统中，以测试其弹性，并迫使工程师设计用于故障的解决方案。这种哲学和实践是大胆的，因为它 *真正* 测试了应用程序的实力。编写软件在周围一切正常运行时也能正确工作，这是一种基本和显而易见的期望，但它毫无意义。挑战在于编写软件，即使在周围一切都在失败的情况下也能工作。作为工程师，我们经常认为在软件中考虑了故障，但在真正发生故障之前我们怎么知道呢？而且，并非所有故障都是二进制的：工作或不工作。最阴险的问题不是明显的故障，而是边缘情况和异常情况：这种问题需要一个故事来解释，而不是简单的故障声明，比如“硬盘死机”。

对于 MySQL 的应用程序也是如此。但是，在 MySQL 行业中，混乱工程不是标准做法，因为玩弄数据库是有风险的，很少有工程师如此大胆。但幸运总是眷顾大胆者，因此这里有 12 种数据库混乱场景，可以测试您的应用程序的实力：

+   MySQL 离线

+   MySQL 响应非常慢

+   MySQL 是只读的

+   MySQL 刚刚启动（冷缓冲池）

+   读取副本离线或非常缓慢

+   在同一地区的故障转移

+   故障转移到不同的地区

+   数据库备份正在运行

+   DNS 解析非常慢

+   网络速度慢（高延迟）或饱和

+   RAID 阵列中的一个硬盘已降级

+   SSD 上的空闲磁盘空间低于 5%

这些 12 种数据库混乱场景中的一些可能不适用于您的基础设施，但大多数都是标准的，并根据应用程序产生有趣的结果。如果您从未进行过混乱工程设计，那么我鼓励您开始，因为混乱不会等到你准备好。

# 高性能 MySQL 非常困难

如果您真诚地应用了本书中的所有最佳实践和技术，我相信您将在 MySQL 中取得卓越的性能。但这并不意味着它会快速或轻松。高性能 MySQL 需要实践，因为资源——书籍、博客、视频、会议等——教给您的是理论，而不是现实。因此，当您开始将本书中学到的东西应用到您的应用程序中时，您可能会遇到以下两个挑战。

第一个挑战是，真实应用的查询通常比这些页面上零散的简短示例更复杂。加之一次性记住和应用如此多的知识的额外挑战：查询指标、索引和索引、`EXPLAIN`输出、查询优化、表定义等等。一开始可能会感到不知所措，但逐个查询来处理，并记住“北极星”和“索引：如何像 MySQL 一样思考”。即使是专家也需要时间来揭示并理解查询的完整故事。

第二个挑战是，真实应用的性能很少仅取决于工作负载的某一个方面。修复慢查询无疑会有所帮助，但可能不够。你需要从整个工作负载着手优化：每个查询、所有数据以及每种访问模式。最终，你将需要应用这本书每一章的知识。（除非你不在云端使用 MySQL，否则忽略第十章。）从第一章到第四章开始小步前进，但务必学习并应用这本书中的所有内容，因为你会需要它们。

MySQL 的性能远不止本书中我所介绍的内容，但我向你保证：这些章节中所传授的知识是全面且有效的。此外，并没有仅专家才知道的秘密能够极大地提升 MySQL 的性能。我从自己的经验中知道这一点，也从与世界上许多顶级 MySQL 专家的合作中了解到这一点。而且，开源软件很难保守秘密。

# 实践：识别防止分裂脑的保护措施

这个实践的目标是识别防止分裂脑的保护措施。它有两个部分：详细说明保护措施，以便每个工程师都理解它们的作用、位置（可能在工具中）以及它们的工作原理，然后仔细审查管理或更改 MySQL 实例的工具，特别是故障转移工具。

如果你不管理 MySQL，那么请安排时间与管理 MySQL 的工程师会面，让他们详细说明他们在运营中如何防止分裂脑，特别是故障转移时。这应该是一个简单的请求，因为防止分裂脑是管理 MySQL 的基本要求。

如果在云中使用 MySQL，情况会有所不同。云服务提供商根据内部设置和管理 MySQL 的方式采取未公开的方法来防止脑裂。例如，使用标准的 Amazon RDS for MySQL 多可用区实例理论上不可能出现脑裂，因为虽然是多可用区，但多个 MySQL 实例不会同时运行。（在一个可用区 [AZ] 中有一个运行中的 MySQL 实例。如果该实例失败，另一个实例将在另一个 AZ 中启动。）但是，如果添加读取副本，则在相同复制拓扑中有多个运行中的 MySQL 实例，Amazon 对于与读取副本相关的脑裂不作任何保证。在云中，假设您负责防止脑裂的护栏，但也要了解云提供商何时会或不会防止脑裂。

如果您在自己的硬件上管理 MySQL，则建议您聘请 MySQL 专家帮助您确定防止脑裂的护栏。（这不应花费太长时间，所以应该是一个简短而经济实惠的合同。）有一个基本的护栏必须实施：在其 *my.cnf* 文件中配置 MySQL 以只读模式启动：`read_only=1`。始终以只读模式启动 MySQL。从这个基础上，其他护栏详细说明了如何切换只读模式，以确保一次只有一个实例处于非只读模式（MySQL 可写）。

###### 小贴士

始终以只读模式启动 MySQL (`read_only=1`)。

一旦工程师理解了护栏，第二部分是仔细审查管理或更改 MySQL 实例的工具，特别是故障转移工具，以确保护栏得到实施并按预期工作。当然，所有代码都应该经过单元测试，但是防止脑裂如此重要，以至于需要进行手动代码审查。在识别护栏时可能存在的代码问题包括：竞争条件、重试和错误处理。最后一点——错误处理——尤为重要：工具是否能（或者应该）在出错时回滚更改？记住：数据完整性比数据可用性更重要。当切换 MySQL 为只读时，工具应该谨慎行事：如果某个操作有非零概率导致脑裂，就不要这样做；让 MySQL 保持只读模式，失败时让人工解决。

底线：对于防止脑裂的护栏要非常清楚。

# 实践：检查数据漂移

这种做法的目的是使用 [`pt-table-checksum`](https://oreil.ly/mogUa) 检查数据漂移。您很幸运：这个工具专门设计得非常简单和自动化。只需下载并运行该工具，它将在大多数情况下自动完成其余工作。如果不行，快速阅读其文档将解答任何问题。

###### 注意

大多数 MySQL 工具需要特殊配置才能与云中的 MySQL 配合工作。

`pt-table-checksum` 只做一件事情：检查并报告数据漂移。根据数据大小和访问负载的不同，它可能会运行数小时或数天。默认情况下，它运行缓慢以避免干扰生产访问。因此，请务必在 `screen` 或 `tmux` 会话中运行它。

当 `pt-table-checksum` 完成对表的检查时，它会打印表的一行结果。输出如下：

```
            TS ERRORS  DIFFS  ROWS  DIFF_ROWS CHUNKS SKIPPED    TIME TABLE
10-21T08:36:55      0      0   200          0      1       0   0.005 db1.tbl1
10-21T08:37:00      0      0   603          0      7       0   0.035 db1.tbl2
10-21T08:37:10      0      2  1600          3     21       0   1.003 db2.tbl3
```

输出的最后一行显示出数据漂移的表，因为列 `DIFFS` 的值不为零。如果任何表有数据漂移，请使用 `--replicate-check-only` 选项重新运行以打印与源不同的副本和分块。(*分块* 是由索引的上限和下限边界值界定的行范围 [通常是主键]。`pt-table-checksum` 通过检查分块中的行来验证，因为逐行检查效率太低且效率低下。) 您将需要制定计划来隔离和调整不一致的行。如果不多，您可以尝试手动隔离和调整它们。如果不行，那么我建议您与 MySQL 专家合作，确保正确完成操作。

# 实践：混沌

这种实践的目标是测试您的应用程序的能力。混沌工程不适合胆小者，因此请从您的演示数据库开始。

###### 警告

这种实践会导致停机。

在接下来的混沌测试中，MySQL 和应用程序应该正常运行，并且有一定的负载。您应该能够充分记录和分析它们的运行状况。

我建议以下混沌操作，但根据您的风险承受能力进行选择：

重启 MySQL

重启 MySQL 测试应用程序在 MySQL 脱机时的响应情况，以及在 MySQL 缓冲区冷启动时的响应情况（特别是 InnoDB 缓冲池）。冷启动需要进行磁盘 I/O 将数据读入内存，导致响应时间比平时慢。这还能让您了解三件事情：MySQL 关闭所需的时间、MySQL 启动所需的时间以及缓冲区热身所需的时间。

启用只读模式

在源实例上设置 `SET GLOBAL read_only=1` 以启用只读模式，并测试应用程序在可以读取但不能写入数据时的响应。工程师们通常认为应用程序在读取方面会继续工作，并且对写入进行优雅失败，但混沌充满了意外。这也有效地模拟了失败的故障转移，这种情况永远不应发生（因为这意味着高可用性的失败），但“永远不应该发生”也包含在混沌的范围内。

停止 MySQL 1 小时

大多数应用程序可以在几秒或几分钟内经受住风暴的考验，甚至可以是十几分钟，但在某个时刻，队列会填满，重试次数会用尽，指数回退时间会变得非常长，速率限制会重置，用户会放弃并转向竞争对手。MySQL 在正常管理的情况下，不应该离线超过几秒钟，但再次：混沌。

2004 年，当我在一个数据中心工作时，在我开始下午 2 点到午夜班之前，一位工程师意外地按到了紧急关机按钮——*关掉了整个数据中心*。在混乱中保持冷静是唯一的答案，所以我先拿了杯咖啡，然后坐下来帮助重新启动数据中心。
