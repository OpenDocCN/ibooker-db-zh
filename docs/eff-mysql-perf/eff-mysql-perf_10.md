# 第十章：MySQL 在云中

云中的 MySQL 本质上与您熟悉（或者说您了解并接受）的 MySQL 相同。在云中，前九章中详细介绍的最佳实践和技术不仅是真实的，而且是*极为*真实的，因为云服务提供商对每个字节和每毫秒工作时间都收费。在云中，性能就是金钱。对前九章的总结如下：

+   性能是查询响应时间（第一章）。

+   索引是性能的关键（第二章）。

+   少数据既能节省存储，也便于访问（第三章）。

+   访问模式允许或抑制性能（第四章）。

+   分片是扩展写入和存储的必要手段（第五章）。

+   服务器指标显示工作负载如何影响 MySQL（第六章）。

+   复制滞后是数据丢失，必须避免（第七章）。

+   事务会影响行锁定和撤销日志（第八章）。

+   即使在云中，还存在其他挑战（第九章）。

如果你接受并应用所有这些细节，MySQL 将在任何地方（云中、本地或其他任何地方）以显著的性能执行应用负载。

为了节省您的时间，我希望问题如此简单——优化工作负载，然后就万事大吉——但是，在云中使用 MySQL 提出了独特的考虑因素。目标是了解并减轻这些云计算中的考虑因素，以便您可以专注于 MySQL，而不是云计算。毕竟，云计算并不特别：在虚拟幕布背后，它是在数据中心运行像 MySQL 这样的物理服务器上运行程序。

本章重点介绍在云中使用 MySQL 时需要注意的事项。有四个主要部分。第一个警告兼容性问题：当 MySQL 不再是 MySQL 时。第二部分是关于云中不同级别的 MySQL 管理的快速讨论。第三部分讨论网络延迟及其与存储 I/O 的关系。第四部分是关于性能和成本的讨论。

# 兼容性

云中的 MySQL 可能不是 MySQL，或者可能是高度修改过的（专有）版本的 MySQL。 MySQL 在云中的兼容性有两个方面：代码兼容性和功能兼容性。

###### 注意

*MySQL* 指的是由 Oracle 发布的 MySQL：官方的、开源的 MySQL 源代码。我也指的是由 Percona 发布的 Percona Server，以及由 MariaDB 基金会发布的 MariaDB Server：它们都是广泛使用、安全稳定的，被视为通用的 MySQL。

*代码兼容性* 涉及的是 MySQL 是否是由 Oracle、Percona 或 MariaDB 发布的相同开源代码。以下九个词语和短语通常用于产品描述和文档，以暗示 MySQL 并非代码兼容，而是稍微（或显著）不同的东西：

+   基于

+   模拟

+   兼容

+   客户端兼容

+   协议兼容

+   线兼容

+   替代

+   插拔兼容

+   与现有工作

代码兼容性很重要，因为 MySQL 很复杂且微妙，我们委托它存储无价的数据。在本书中，我专注于讨论缩小 MySQL 复杂性的范围，但像 “页面刷新” 和 “行锁定” 这样的章节暗示了问题的深度。当任何公司修改 MySQL 源代码时，风险是四倍的：数据丢失、性能退步、错误和不兼容性。修改越大，风险越大。在云端，我见过后三者；幸运的是，我没有看到云服务提供商丢失数据。

###### 提示

如果你对 MySQL 在云端是否与代码兼容有任何疑问，请向云服务提供商询问，“这是否与由 Oracle 发布的开源 MySQL 相同？”

为了全面呈现论点，而不仅仅是负面（风险），云服务提供商修改 MySQL 以提供额外的价值：改进性能，修复错误，并添加客户所需的功能。一些修改是有价值且值得风险的。但如果你在云中使用不与代码兼容的 MySQL，你需要了解修改的程度。对于在云中使用 MySQL 的专业工程师来说，这是基本的尽职调查。

> 给出足够多的眼球，所有的 bug 都是浅显的。
> 
> Eric S. Raymond

*功能兼容性* 是 MySQL 是否包含在云提供商或 MySQL 发行版之外不可用的功能。例如，Oracle 发布了两个发行版：MySQL 社区版和 MySQL 企业版。前者是开源的；后者包含专有功能。[Oracle Cloud Infrastructure (OCI)](https://www.oracle.com/cloud) 使用后者，这是好事：为云服务的金钱提供更多价值。但这也意味着，如果你依赖于 MySQL 企业版特有的功能，你不能直接迁移到另一个云提供商或 MySQL 发行版。对于 Percona Server 和 MariaDB Server 也是如此：这些 MySQL 的发行版有独特的功能，这是好事，但它也使迁移到其他云提供商或 MySQL 发行版变得复杂。

功能兼容性之所以重要，与开源软件重要的原因相同：自由更改。软件，包括 MySQL 在内，应该赋予工程师和用户权力，而不是将我们锁定在特定的云提供商或供应商中。这种推理比技术更具哲学意义，这也是为什么我将再次全面呈现整个论点：一些功能是有价值且不值得更改以保留的。但如果你选择使用在云服务提供商或 MySQL 发行版之外不可用的功能，你需要记录原因，以便未来的工程师可以理解其中的风险（以及需要替换的内容），如果他们使用其他云提供商或 MySQL 发行版。对于在云中使用 MySQL 的专业工程师来说，这也是基本的尽职调查。

# 管理（DBA）

我们从本书的第一页起就成功地避开了 MySQL 管理（DBA 工作），所以我们现在也不会失败，但是云中的 MySQL 引发了一个你需要了解和解决的问题：谁来管理 MySQL？表面上看，云提供商管理 MySQL，但事实并不简单，因为管理 MySQL 涉及许多操作。做好准备：我将把本书引向接近 DBA 工作的危险领域，以便解释清楚。

表 10-1 是 DBA 操作的部分列表，指明了谁来管理它们：您还是云。

表 10-1\. DBA 操作列表

| 操作 | 您 | 云 |
| --- | --- | --- |
| 配置 |  | ✓ |
| 配置 |  | ✓ |
| MySQL 用户 | ✓ |  |
| 服务器指标 | ✓ |  |
| 查询指标 | ✓ |  |
| 在线架构变更（OSC） | ✓ |  |
| 失败恢复 |  | ✓ |
| 灾难恢复（DR） | ✓ |  |
| 高可用性（HA） | ✓ | †^(a) |
| 升级 |  | ✓ |
| 备份和恢复 |  | ✓ |
| 变更数据捕获（CDC） | ✓ |  |
| 安全性 | ✓ |  |
| 帮助 | ✓ |  |
| 成本 | ✓ |  |
| ^(a) 指示一些管理。 |

让我快速浏览一下表 10-1 中的 15 个操作，因为即使是在高层次上了解全部范围，也有助于避免 MySQL 管理中的漏洞，如果不加以解决将成为问题。也被称为*CYA*：保护你的管理工作。

提供 MySQL 是云服务提供商必须提供的基本操作：在计算机上运行 MySQL 的最底层操作。云服务提供商使用了一个合理的 MySQL 配置，但请务必再次确认，因为没有默认配置能够适合每一个客户。除了一个根用户用来给你对 MySQL 服务器的初始控制权限外，云服务提供商不管理 MySQL 用户。服务器和查询指标也是你的责任来收集和报告。尽管一些云服务提供商暴露了基本的服务器指标，但没有一个能够接近第六章中详细介绍的所有指标。在云中运行 `ALTER` 语句而不影响工作负载完全是你的责任，并且由于书外技术原因，这些操作在云中通常会更加困难。云服务提供商会处理故障转移：当硬件或 MySQL 宕机时，云服务提供商将执行故障转移以恢复可用性。但是云服务提供商不处理*灾难恢复*：当整个区域发生故障时，必须通过在不同地理位置运行 MySQL 来恢复可用性。考虑到前两种操作，高可用性（HA）在云中的管理是混合的（因此†在云列中）。在这里涵盖 MySQL 在云中高可用性的全面讨论过于细致；我们只能说云提供了一定程度的高可用性。云服务提供商会升级 MySQL，这非常好，因为这一操作在大规模时非常繁琐。云服务提供商备份 MySQL，并提供长期备份保留以及恢复备份的方法——这些都非常重要。你负责变更数据捕获（CDC），通常需要另一个工具或服务来充当副本，从 MySQL 中转储（或流式传输）二进制日志到另一个数据存储（通常是大数据存储或数据湖）。在云中保护 MySQL 的安全性是你的责任——云本身*不*是安全的。云服务提供商会帮助你一般性地运行 MySQL，但不要期望得到太多（或任何）有关 MySQL 性能的帮助，除非你的公司为此支付了支持费用。最后，你必须管理成本：云因成本超出工程师预期而臭名昭著。

###### 警告

三大云服务提供商——亚马逊、谷歌和微软——为 MySQL（作为托管服务）提供了 99.95% 或 99.99% 的可用性 SLA，但请仔细阅读细则和法律详情。例如，维护窗口通常不计入 SLA。或者，如果 MySQL 没有由你正确配置，SLA 可能会失效。云服务提供商的高可用性和 SLA 总是有细节和注意事项。

表 10-1 是描述性的，而非规定性的，因为不同的云服务提供商和第三方公司在云中提供不同级别的 MySQL 管理。例如，一些公司在云中（或本地）*完全*管理 MySQL。作为一个使用 MySQL 而不是管理 MySQL 的工程师，你只需要知道所有操作都是被管理的——所有的方框都是被勾选的，这样它们就不会干扰你的工作。一旦你知道了这一点，请忘记你在本节中读到的一切，否则你会在不知不觉中成为一个 MySQL 数据库管理员，二十年过去了，加入你团队的下一个工程师在你忙于解决一个无法解释的点版本升级后的性能回归问题时还是个婴儿。

# 网络和存储……延迟

当在本地（在公司租赁的数据中心空间内）运行 MySQL 时，本地网络永远不应该是你考虑或担心的问题，假设它是由胜任的专业网络工程师设计和布线的。本地网络具有亚毫秒级的延迟，速度快且稳定。本地网络应该比数据库更无聊（回想“正常和稳定：最好的数据库是一种无聊的数据库”）。

但是云是全球化的，广域网络具有较高的延迟和较低的稳定性（延迟和吞吐量波动较大）。例如，旧金山与纽约之间的网络往返时间（RTT）约为 60 毫秒，加减 10 毫秒。如果你在旧金山（或者美国西海岸的任何地方）运行 MySQL，而应用程序在纽约市（或者美国东海岸的任何地方），最小的查询响应时间约为 60 毫秒。这比本地网络慢 60 倍。^(1) 你会注意到这种慢速，但它不会在查询响应时间中显示出来，因为延迟超出了 MySQL 的范围。例如，查询配置文件（参见“查询配置文件”）显示一个查询执行需要 800 微秒，但你的应用程序性能监控（APM）显示查询执行需要 60.8 毫秒：MySQL 需要 800 微秒，网络延迟需要 60 毫秒。

长距离的网络延迟受到光速的物理限制和中间路由的恶化影响。因此，你无法克服这种延迟，只能绕过它。例如，参考“写入入队”：在本地进行入队，远程写入——其中*远程*是任何导致高网络延迟的进程。

转回本地网络，幸好它们速度飞快且稳定，因为云提供商通常将 MySQL 数据存储在*网络附加存储*上：通过本地网络连接到服务器的硬盘驱动器。相比之下，*本地附加存储*（或*本地存储*）是直接连接到服务器的硬盘驱动器。云提供商出于本书范围之外的各种原因使用网络附加存储。重要的是要知道，网络附加存储比本地存储慢得多且不稳定。三大云提供商——亚马逊、谷歌和微软——发布了关于网络附加存储（使用 SSD）的“单位时间内延迟为一位数毫秒”^(2)，除了亚马逊的 io2 Block Express 拥有亚毫秒级延迟。总之，在云中使用 MySQL 时，可以预期存储具有单位时间内延迟，这相当于旋转磁盘。

网络附加存储与本地存储（使用 SSD；不使用旋转磁盘）的速度相差一个数量级，但这是你应该解决的问题吗？如果你从具有高端本地存储（SSD）的裸金属硬件迁移到云中的 MySQL，并且应用程序大量且持续地利用本地存储的 IOPS（见“IOPS”），那么是的：验证网络附加存储的增加延迟是否导致性能下降的连锁反应（因为 IOPS 会产生延迟）。（IOPS 的大量和持续利用是写入密集工作负载的标志：参见“读/写”。）但如果你已经在云中，或者在云中启动新的应用程序，那么不用担心或考虑云中的存储延迟。相反，建立高度优化的查询（索引）、数据和访问模式的基础——分别在第 2、3 和 4 章中讨论——云中的存储延迟可能永远不会成为问题。

如果云中的存储延迟成为问题，则需要进一步优化工作负载、分片（第五章）或购买更好（更昂贵）的云存储。记住：Netflix 以及其他非常大型和成功的公司都在云中运行。在云中，MySQL 的性能潜力几乎是无限的。问题是：你能负担得起吗？

# 性能即金钱

与本书的开头——“一个关于虚假性能的真实故事”——形成了相似性。但在云中，客户会为了“修复”MySQL 性能而购买更多的 RAM。三大云提供商之一的工程师告诉我，大多数 MySQL 实例都被过度配置：客户为应用程序所需或利用的容量支付了更多费用^(3)。

行业是否已经完全回到云的可伸缩性，而性能只是更大的实例？不，绝对不是：*性能是查询响应时间*；在云中，每个字节和毫秒的性能都按小时计费，这使得本书中的所有最佳实践和技术比以往任何时候都更加重要。

如果您曾使用过云服务，下面的信息可能不会让您感到意外。但如果您是云计算新手，那么请让我第一个告诉您：云计算定价复杂，几乎难以掌控，并且经常低估（这意味着超出预算）。即使工程师们竭力估算和控制云计算成本，这一点仍然如此；当他们不这样做时，我曾见过六位数的惊喜：超过预算的 10 万美元。以下是在云中使用 MySQL 时避免计费意外的三个最重要的事项。

第一件要知道的事情是，*价格每升一级都会翻倍*，因为底层计算资源（运行 MySQL 的虚拟服务器）的资源（虚拟 CPU 计数和内存大小）在每个级别上都会翻倍。例如，如果最低级别的计算是 2 个虚拟 CPU 和 8 GB RAM，则上一级是 4 个虚拟 CPU 和 16 GB RAM——价格也会翻倍。有几个例外，但期望翻倍。因此，您无法逐步增加成本；每个您扩展的计算级别的成本都会翻倍。从工程角度来看，从 2 个虚拟 CPU 扩展到 8 个虚拟 CPU 仍然是非常小的计算量，但价格却会翻倍。为了形象化地描述，想象一下，如果您的每月抵押贷款或租金翻倍，或者您的汽车贷款翻倍，或者您的学生贷款翻倍。您可能会感到不安，这是理所当然的。

第二件要知道的事情是，在云中，一切都是需要花钱的。计算成本只是开始。以下列表包括在云中 MySQL 的常见费用，除了计算成本外：

+   存储类型（IOPS）

+   数据存储（大小）

+   备份（大小和保留时间）

+   日志（大小和保留时间）

+   高可用性（副本）

+   跨区域数据传输（大小）

+   加密密钥（用于加密数据）

+   保密（存储密码）

此外，这些费用是按实例计费的。例如，如果您创建了五个读取副本，则每个副本都将计费用于数据存储、备份等。我希望事情能更简单些，但这是现实：在使用云中的 MySQL 时，您需要调查、理解和估算所有成本。

###### 警告

一些云中的 MySQL 的专有版本（参见“兼容性”）具有额外的费用，或者完全不同的定价模型。

第三个也是最后一个要了解的是，云服务提供商提供折扣。不要付全价。至少，通过一年或三年的承诺，可以显著降低成本，而不是按月支付。其他折扣因云服务提供商而异：寻找（或询问）保留实例、承诺使用和批量折扣。如果您的公司依赖云，那么它很可能已经与云服务提供商签订了合同。找出是否是这种情况，以及合同定价细节是否影响云中 MySQL 的成本。如果幸运的话，合同可能会减少*并且*简化成本，从而让您专注于使用 MySQL 的有趣细节。

# 摘要

本章强调了在云中使用 MySQL 时需要了解的内容。重要的要点是：

+   在云中，MySQL 的代码和功能兼容性各不相同。

+   您的尽职调查是了解与开源 MySQL 相比的任何代码或功能不兼容性。

+   MySQL 可以由云服务提供商或第三方公司部分或完全管理。

+   在广域网上的网络延迟会增加查询响应时间数十至数百毫秒。

+   云中的 MySQL 数据通常存储在网络附加存储上。

+   网络附加存储的延迟为个位数毫秒，相当于旋转磁盘。

+   云服务对所有内容收费，成本可能（而且经常）超出预算。

+   云服务提供商提供折扣；不要付全价。

+   在云中的性能是查询响应时间。

这是最后一章，但不要`\q`：还有一个练习。

# 实践：尝试云中的 MySQL

这个实践的目标是在云中尝试 MySQL——只是为了看看它是如何运作的，不需要进行任何 DBA 工作。一方面，我不想为以下五个云服务提供商做免费营销——本书严格是技术性的。但另一方面，使用云中的 MySQL 越来越普遍，因此我希望你能做好准备并取得成功。此外，这是一次*免费试用*：以下五个云服务提供商都有免费层或初始账户信用额。暂时不要支付任何费用：云服务提供商必须通过向您证明其服务的价值来赢得您的业务和资金。

尝试使用任意一个（或多个）云服务提供商创建和使用 MySQL：

+   [MySQL 数据库服务](https://oreil.ly/Z7ZA8) by Oracle

+   [SkySQL](https://oreil.ly/tn1KY) by MariaDB

+   [关系型数据库服务(RDS)](https://oreil.ly/yNPfc) by Amazon

+   [Azure 数据库服务 MySQL 版](https://oreil.ly/Tj3Y1) by Microsoft

+   [Cloud SQL](https://oreil.ly/pnsVt) by Google

如果发现其中一个易于使用且可能有价值，请调查其定价模型和额外成本。我特意使用动词*调查*，因为正如我在“性能即金钱”中提到的：云定价是复杂的，几乎难以解决，并经常被低估（这意味着超出预算）。

###### 注意

在免费试用期结束或初始账户余额耗尽之前，请不要忘记销毁您的云中 MySQL 实例。

这是本书中的最后一个实践，但我鼓励你继续学习和实践，因为 MySQL 不断发展，云服务也是如此。因此，即使是 MySQL 专家也必须继续学习和实践，这让我想起了一句禅宗谚语，正是以此结束本书：

> 砍柴。挑水。

^(1) 从技术上讲，所有网络的速度都是一样的：光速。问题在于物理距离和长距离中间路由。

^(2) 参见[Amazon EBS 功能](https://oreil.ly/NIly1)，[Google 的块存储性能](https://oreil.ly/7Zxaj)，以及[Microsoft Azure 的高级存储](https://oreil.ly/LMg03)。

^(3) 由于保密协议，我无法引用来源。
