# 附录 A. 升级 MySQL

升级是稳定性和功能之间的权衡。在选择升级时，您应考虑这一点。使用 MySQL 的最大优势之一是其广泛的安装基础。这意味着您可以从许多其他人测试和使用 MySQL 中获益。如果升级到太新的版本，您可能会不知不觉地引入一个错误或回归到您的环境中。如果保持太落后，您可能会遇到不明显的错误或无法利用为性能优化的功能。

# 为什么升级？

决定继续进行版本升级可能是一个风险的过程。通常涉及备份所有数据，测试更改，然后运行升级过程。在我们深入讨论细节之前，了解为什么您可能希望升级是很重要的。

有许多升级的原因：

安全漏洞

多年来，发现 MySQL 中的安全漏洞的可能性已经减少，但仍然有可能。您或您的安全团队可能会评估这些漏洞，并确定您应该执行升级。

已知错误

在生产环境中遇到未知或无法解释的行为时，我们建议找出您正在运行的 MySQL 版本，然后阅读最新版本的发行说明。您完全有可能发现您正在经历的情况实际上是 MySQL 中的软件错误。如果您的问题得到解决，您可能需要升级 MySQL。

新功能

MySQL 在如何添加功能方面并不总是严格遵循主要/次要/点版本发布策略。许多人可能期望点版本（例如，从 8.0.21 到 8.0.22）只包含错误修复，而次要版本更改（从 8.0 到 8.1）将包含次要功能。Oracle 经常在次要点版本中发布可能对您的工作负载产生影响的新功能。这种策略是一把双刃剑，这就是为什么在升级之前应该阅读所有的发行说明。

MySQL 终止生命周期支持

Oracle 为 MySQL 设置了终止生命周期（EOL）时间。一般来说，建议保持在支持的版本内，这样至少安全修复仍然受支持。

现在我们已经讨论了影响您升级决定的各种因素以及具体版本，让我们讨论规划和安全完成升级的过程。

# 升级生命周期

一旦您做出升级是正确的决定，通常会采取以下步骤：

1.  阅读该版本的发行说明，包括任何次要更改。

1.  阅读官方文档中的升级说明。

1.  执行新版本的测试。

1.  最后，升级您的服务器。

发行说明通常包含重要信息，如新功能、更改或已弃用的功能，通常还会列出已修复的错误。升级说明为您提供了如何执行升级的详细概述，并提醒您在继续之前需要了解的任何重要信息。

此外，您还应该制定一个计划，以应对引入问题的情况，比如查询开始表现不佳，或者更糟糕的是，您开始遇到崩溃错误。对于所有主要和次要版本更改（例如，从 8.0 降级到 5.7 或从 5.7 降级到 5.6），唯一的降级方法是从升级之前的备份恢复。这使得升级特别危险，因此请确保您有一个计划。

###### 警告

需要注意的是，自 MySQL 8.0 起，您也不能降级点版本。例如，一旦您运行 8.0.25，您就无法降级到 8.0.24，而不导出所有数据并重新导入。

# 测试升级

一旦您阅读了发布和升级说明，您应该对任何测试的关注点或重点有很好的理解。下一步将是测试这个新版本在您的工作负载下的行为。您还需要验证您已经审查了配置文件。MySQL 的新版本通常会重命名变量或完全弃用它们。

测试是一个难以完成的步骤，每种方法都有注意事项。考虑到之前提到的关于降级的风险，您应该在升级之前尽可能多地采用这些方法。

## 开发环境测试

希望您有一个用于数��的开发环境。这是开始测试的好地方，可以在共享开发数据库上进行测试，也可以在独立数据库上进行测试。使用这个的主要目标是发现任何明显的语法问题。大多数开发环境不包含与生产数据相同大小的数据，因此很难进行准确的测试。例如，您可能运行您常用的查询并看到它们正常，因为它们只访问表中的 10 行。当您转到生产环境时，表中有 1000 万行，您可能会看到退化。

## 生产镜像

另一个选择是创建生产数据的副本，并将您的 SQL 流量发送到副本。这种方法在[Etsy 的 Code As Craft 博客上的一篇博文](https://oreil.ly/yByfy)中展示过。简而言之，您有生产数据库的第二个副本，停止使用复制，并在副本上升级 MySQL。完成后，使用*tcpdump*和*pt-query-digest*的组合将流量发送到您的实时生产系统*和*副本。您的应用程序仍然仅使用生产系统进行实时流量，而具有升级版本的副本可以为您提供性能指标并显示语法错误。

## 副本

如果您的拓扑结构有读取副本并且您有能力将副本脱离池，您可以考虑首先升级其中一个副本。这将允许您查看实际生产工作负载下的读取流量表现。如果观察到错误或退化，您可以将副本脱离池并进行调整。这种方法的缺点是您无法测试性能或写入流量。

## 工具

Percona Toolkit 提供了工具*pt-upgrade*，它接受查询作为输入，针对两个不同的目标运行这些查询，并生成报告告诉您行数、行数据或错误的任何差异。由于它可以接受许多不同类型的输入（慢查询日志、常规查询日志、二进制日志），它可以是获得额外测试覆盖的好选择。

最佳使用方法是首先收集您最感兴趣的查询，可以使用慢查询日志或二进制日志。然后设置两个相同的系统，仅将其中一个升级到新版本，并对两者运行*pt-upgrade*以查看差异。

# 大规模升级

升级 MySQL 非常简单，并且在官方 MySQL 文档中有详细介绍。简而言之，如果您正在进行原地升级，您将停止 MySQL，替换二进制文件，启动 MySQL，然后运行`mysql_upgrade`脚本。

如果您在数百个 MySQL 服务器上执行此操作，这可能会变得重复。我们建议尽可能自动化这个过程。您可以使用 Ansible 的一种方式来实现这一点。

这里是一个建议的安全升级过程的骨架，您可以将其用作构建 Ansible playbook 的指南，如果您选择的话：

1\. 验证目标。

你要做的第一件事是防止生产系统的意外升级。如果您有一个可以查询以确定数据库是否正在接收流量的系统，这是检查的地方。如果您遵循我们在第五章的建议，应该使用`read_only`标志来防止对副本的意外写入。如果没有可以检查的系统，这可以作为一个很好的替代方案。如果服务器是可写的，那么您可能不希望对其进行升级，因为它可能正在接收生产写入。您还可以使用此步骤验证您是否已经升级了服务器。这样可以稍后对其运行 playbook，而它将不执行任何操作。

2\. 设置停机状态。

希望你的系统正在被监控。下一步涉及设置某种形式的停机或警报抑制，以便在 MySQL 在新版本上重新启动时不会收到警报。

3\. 其他前提条件。

如果您有任何其他依赖服务，比如配置管理工具或其他监控工具，在 MySQL 离线时会生成错误，现在是关闭它们的好时机。

4\. 删除旧包。

我们首选的方法是此时完全删除任何已安装的 MySQL 包。这有助于避免主要版本（5.7 到 8.0）之间的任何冲突包。

5\. 安装新包。

接下来，您将希望在系统上安装新包。

6\. 启动 `mysqld`。

启动`mysqld`服务。

7\. 运行 `mysql_upgrade`。

如果早于 MySQL 8.0，²运行`mysql_upgrade`过程。特别注意，如果您像我们建议的那样使用`super_read_only`运行 MySQL，则在`mysql_upgrade`步骤中将其设置为`OFF`。

8\. 重新启动 `mysqld`。

我们更喜欢在此时对`mysqld`进行干净重启。这将确保它正确启动并使用升级后的文件，并且您的配置文件也在工作。

9\. 验证您可以连接。

简单连接并运行`SELECT 1`以确保 MySQL 正常工作。

10\. 恢复任何已禁用的服务。

如果关闭了任何配置管理或监控工具，请重新启用它们。

11\. 清除停机状态。

将服务器从停机状态中取出，以便观察是否有任何升级过程失败的情况。

通过这个过程，您可以将您的运行手册指向任何服务器，并仅升级不接收流量的未升级节点。

# 摘要

升级 MySQL 有许多原因，最引人注目的是修复您正在遇到的错误或利用新功能。例如，MySQL 8.0 引入了一个功能，InnoDB 可以立即添加列，无需重建整个表。这种功能增强对于执行大量`ALTER TABLE .. ADD COLUMN`语句的公司来说可以节省大量时间。通过努力进行安全升级过程，最终将节省执行这些列添加语句的时间，以及改进开发人员体验。

主要版本升级可能令人生畏。您绝对应该花费大量精力测试升级是否会产生任何不良影响。通常，您希望检查升级是否导致任何查询延迟偏差或新错误。一旦您获得信心，慢慢推出并具有回滚过程。

最后，如果您有大量服务器需要管理，请考虑大力投资于尽可能自动化该过程。自动化可以使升级过程变得更容易重复，并比直接登录每台服务器更节省时间，也减少了因在错误服务器上而导致的拼写错误和意外停机的几率。

¹ 长期参与 MySQL 社区的成员 Stewart Smith，著名地提出了点二十规则：“[规则] 是指软件在发布点二十版本之前永远不会真正成熟。”虽然这不是一个严格的规则，但它突显了新版本和稳定性之间的权衡。

² MySQL 8.0 将 `mysql_upgrade` 过程移入了服务器启动过程中。无需作为额外步骤运行。
